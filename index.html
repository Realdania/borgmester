<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Borgmesterværktøjet</title>
<link rel="shortcut icon" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<style>
    :root { --pad:18px; --font-size:13px; --tbl-height:min(52vh,480px); }
    html, body { min-height:100%; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:var(--font-size); line-height:1.35; color:#111; background:#fff; }
    .page { display:grid; grid-template-rows:auto 1fr; min-height:100vh; }
    .header { padding:var(--pad); padding-bottom:6px; display:flex; align-items:center; gap:14px; }
    .brand { flex:1; min-width:0; }
    h1 { color:#FA1E32; margin:0 0 2px 0; font-size:21px; }
    .sub { color:#5A5A5A; margin:0; font-size:12.5px; }
    .logo-wrap { display:flex; align-items:center; justify-content:flex-end; }
    .logo-wrap img { height:40px; width:auto; object-fit:contain; }
    @media (max-width:640px) {
      .header { flex-direction:column; align-items:flex-start; gap:8px; }
      .logo-wrap { alignself:flex-end; }
      .logo-wrap img { height:34px; }
    }

    .content { padding:var(--pad); padding-top:6px; }
    .wrap { display:grid; grid-template-columns:280px 1fr; gap:12px; }
    .panel { background:#fff; border:1px solid #e1e1e1; border-radius:14px; padding:10px; box-shadow:0 1px 3px rgba(0,0,0,.04); }

    /* Filtre – kompakte men pæne */
    .filters {
      display:flex;
      flex-direction:column;
      gap:8px;
      background:#fafafa;
      border-radius:12px;
      padding:8px;
    }
    .filters-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .filters-header h3 {
      margin:0;
      font-size:13px;
    }
    .filters-top-actions { display:none; }  /* ikke brugt længere */
    .facet {
      margin-bottom:4px;
      padding-bottom:5px;
      border-bottom:1px dashed #e1e1e1;
    }
    .facet:last-of-type {
      border-bottom:none;
      padding-bottom:0;
      margin-bottom:0;
    }
    .facet label { display:block; font-weight:600; margin-bottom:3px; font-size:12px; color:#5A5A5A; }
    .checkboxes { display:flex; flex-wrap:wrap; gap:6px 6px; }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #e1e1e1;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      background:#fff;
      transition:background-color .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
    }
    .chip input { margin:0; margin-right:3px; }
    .chip:hover {
      box-shadow:0 0 0 1px #FA1E3222;
      border-color:#FA1E3233;
    }
    .chip input:checked + span {
      color:#FA1E32;
      font-weight:600;
    }

    .btn { background:#FA1E32; color:#fff; border:none; padding:6px 9px; border-radius:9px; cursor:pointer; font-size:12.5px; }
    .btn.small { padding:4px 7px; font-size:12px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .filters-actions { display:flex; gap:6px; margin-top:4px; flex-wrap:wrap; }
    .filters footer { margin-top:4px; color:#5A5A5A; font-size:11.5px; }

    .right { display:block; max-width:100%; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .toolbar input[type="text"] { flex:1; padding:6px 8px; border:1px solid #e1e1e1; border-radius:9px; font-size:12.5px; }

    .table-container { height:var(--tbl-height); overflow:auto; border:1px solid #e1e1e1; border-radius:12px; background:#fff; }
    table { width:100%; border-collapse:collapse; font-size:12.5px; }
    thead th { text-align:left; padding:9px 10px; border-bottom:2px solid #e1e1e1; background:#fafafa; position:sticky; top:0; z-index:1; }
    tbody td { padding:9px 10px; border-bottom:1px solid #f0f0f0; }
    tbody tr:hover { background:#fff9f9; }

    .selected-container {
      margin-top:8px;
      border:1px solid #e1e1e1;
      border-radius:12px;
      padding:8px;
      background:#fff;
      display:none;  /* vises først når der er valgt noget */
    }
    .selected-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .selected-title { font-weight:700; margin:0; color:#5A5A5A; font-size:12.5px; }
    .selected-actions { display:flex; gap:6px; flex-wrap:wrap; }

    .kpi { margin-top:8px; padding:8px; }
    .kpi h3 { margin:0 0 4px 0; font-size:13px; }
    .kpi-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:6px; }
    .kpi-box { border:1px solid #e1e1e1; border-radius:10px; padding:7px; }
    .kpi-box .label { color:#5A5A5A; font-size:11px; }
    .kpi-box .value { font-weight:700; font-size:15px; }
    .muted { color:#5A5A5A; font-size:11.5px; }
    .limit-msg { color:#FA1E32; font-weight:600; display:none; }
    .auto-msg { color:#5A5A5A; font-size:11.5px; margin-top:4px; display:none; }

    .loader { padding:7px 9px; background:#fff3f3; border:1px solid #e1e1e1; border-radius:10px; margin-bottom:6px; }
    </style>
</head>
<body>
  <div class="page">
    
    <div class="header">
      <div class="brand">
        <h1>Borgmesterværktøjet</h1>
        <p class="sub">Filtrér, vælg borgmestre og eksportér udvalget som CSV. Valg er begrænset til 7.</p>
      </div>
      <div class="logo-wrap" title="Realdania">
        <img src="realdania-logo.png" alt="Realdania logo" loading="eager" decoding="async">
      </div>
    </div>
    

    <div class="content">
      <div class="wrap">
        <div class="panel">
          <div class="filters"><div class="filters-header">  <h3>Filtrér i tabellen</h3>  <button class="btn small" id="clearFilters">Ryd alle filtre</button></div><div class="facet"><label>Køn</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Køn" value="K"><span>K</span></label><label class="chip"><input type="checkbox" data-facet="Køn" value="M"><span>M</span></label></div></div><div class="facet"><label>Landsdel</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Landsdel" value="Fyn og øerne"><span>Fyn og øerne</span></label><label class="chip"><input type="checkbox" data-facet="Landsdel" value="København, Nord- og Østsjælland"><span>København, Nord- og Østsjælland</span></label><label class="chip"><input type="checkbox" data-facet="Landsdel" value="Midtjylland"><span>Midtjylland</span></label><label class="chip"><input type="checkbox" data-facet="Landsdel" value="Nordjylland"><span>Nordjylland</span></label><label class="chip"><input type="checkbox" data-facet="Landsdel" value="Sjælland og øerne"><span>Sjælland og øerne</span></label><label class="chip"><input type="checkbox" data-facet="Landsdel" value="Syd- og Sønderjylland"><span>Syd- og Sønderjylland</span></label></div></div><div class="facet"><label>Område</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Område" value="1"><span>1</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="2"><span>2</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="3"><span>3</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="4"><span>4</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="5"><span>5</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="6"><span>6</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="7"><span>7</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="8"><span>8</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="9"><span>9</span></label><label class="chip"><input type="checkbox" data-facet="Område" value="10"><span>10</span></label></div></div><div class="facet"><label>Parti</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Parti" value="A"><span>A</span></label><label class="chip"><input type="checkbox" data-facet="Parti" value="B"><span>B</span></label><label class="chip"><input type="checkbox" data-facet="Parti" value="C"><span>C</span></label><label class="chip"><input type="checkbox" data-facet="Parti" value="F"><span>F</span></label><label class="chip"><input type="checkbox" data-facet="Parti" value="I"><span>I</span></label><label class="chip"><input type="checkbox" data-facet="Parti" value="L"><span>L</span></label><label class="chip"><input type="checkbox" data-facet="Parti" value="V"><span>V</span></label></div></div><div class="facet"><label>Kommunegruppe</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Kommunegruppe" value="Hovedstadskommuner"><span>Hovedstadskommuner</span></label><label class="chip"><input type="checkbox" data-facet="Kommunegruppe" value="Landkommuner"><span>Landkommuner</span></label><label class="chip"><input type="checkbox" data-facet="Kommunegruppe" value="Oplandskommuner"><span>Oplandskommuner</span></label><label class="chip"><input type="checkbox" data-facet="Kommunegruppe" value="Provinsbykommuner"><span>Provinsbykommuner</span></label><label class="chip"><input type="checkbox" data-facet="Kommunegruppe" value="Storbykommuner"><span>Storbykommuner</span></label></div></div><div class="facet"><label>Tidligere valgt fra valggruppen</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Tidligere valgt fra valggruppen" value="Ja"><span>Ja</span></label><label class="chip"><input type="checkbox" data-facet="Tidligere valgt fra valggruppen" value="Nej"><span>Nej</span></label></div></div><div class="facet"><label>Anciennitet</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Anciennitet" value="Genvalgt"><span>Genvalgt</span></label><label class="chip"><input type="checkbox" data-facet="Anciennitet" value="Nyvalgt"><span>Nyvalgt</span></label></div></div><div class="facet"><label>Konstitueringsaftale indgået</label><div class="checkboxes"><label class="chip"><input type="checkbox" data-facet="Konstituering faldet på plads" value="Ja"><span>Ja</span></label></div></div><div class="filters-actions">  <button class="btn" id="quickSelect">Genopstil genvalgte repræsentantskabsmedlemmer</button></div><footer>Senest opdateret: 08.12.2025 kl. 13:49</footer></div>
        </div>

        <div class="panel right">
          <div class="loader" id="loader">Henter (krypterede) data…</div>

          <div class="toolbar">
            <input id="searchBox" type="text" placeholder="Søg (kommune, borgmester, parti…)" disabled>
          </div>

          <p class="muted" id="tableCount">Viser 0 borgmestre</p>

          <div class="table-container">
            <table id="tbl">
              <thead>
                <tr>
                  <th>Vælg</th>
                  <th>Kommune</th><th>Borgmester efter valget</th><th>Parti</th><th>Stemmeandel ved KV25</th><th>Alder i valgåret</th><th>Køn</th><th>Anciennitet</th><th>Borgmester før valget</th><th>Kommunegruppe</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="selected-container">
            <div class="selected-header">
              <p class="selected-title">Valgte (0):</p>
              <div class="selected-actions">
                <button class="btn small" id="autoFill">Fyld automatisk op til 7 (gyldig kombination)</button>
                <button class="btn small" id="exportCsv" disabled>Eksportér valgte som CSV</button>
                <button class="btn small" id="clearSelectedAll">Ryd alle valgte</button>
              </div>
            </div>
            <table id="tblSelected">
              <thead>
                <tr>
                  <th>Fjern</th>
                  <th>Kommune</th><th>Borgmester efter valget</th><th>Parti</th><th>Stemmeandel ved KV25</th><th>Køn</th><th>Anciennitet</th><th>Område</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="kpi panel">
            <h3>Status & nøgletal (blandt valgte)</h3>
            <div class="kpi-grid">
              <div class="kpi-box"><div class="label">Valgt (maks 7)</div><div class="value" id="kpi_total_selected">0</div></div>
              <div class="kpi-box"><div class="label">Gns. alder</div><div class="value" id="kpi_mean_age">-</div></div>
            </div>
            <p class="muted">Fordelinger:</p>
            <div class="kpi-grid">
              <div class="kpi-box"><div class="label">Køn (K/M)</div><div class="value" id="kpi_gender">-</div></div>
              <div class="kpi-box"><div class="label">Landsdel</div><div class="value" id="kpi_landsdel">-</div></div>
              <div class="kpi-box"><div class="label">Kommunegruppe</div><div class="value" id="kpi_kommunegruppe">-</div></div>
              <div class="kpi-box"><div class="label">Parti</div><div class="value" id="kpi_parti">-</div></div>
              <div class="kpi-box"><div class="label">Område</div><div class="value" id="kpi_omraade">-</div></div>
            </div>
            <div class="limit-msg" id="limitMsg">Du kan højest vælge 7.</div>
            <div id="autoMsg" style="margin-top:4px; font-size:11.5px; color:#5A5A5A; display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>

// ===== ENCRYPTED LOADER (PBKDF2 + AES-GCM via WebCrypto) — custom adgangsmodal =====
const ENC_URL = "encrypted_data.json";

// Enkel modal der returnerer adgangskoden som Promise
function askPasswordModal({
  title = "Realdanias borgmesterværktøj",
  label = "Indtast adgangskode",
  confirmText = "OK",
  cancelText = "Annullér"
} = {}
) {
  return new Promise((resolve, reject) => {
    const overlay = document.createElement("div");
    overlay.style.cssText = `
      position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex;
      align-items:center; justify-content:center; z-index:99999;`;

    overlay.innerHTML = `
      <div style="background:#fff; border-radius:14px; padding:20px; width:min(92vw,380px);
                  box-shadow:0 10px 30px rgba(0,0,0,.15); border:1px solid #eee;
                  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
        <h2 style="margin:0 0 10px 0; font-size:18px; color:#FA1E32;">${title}</h2>
        <label style="display:block; margin:0 0 6px 0; font-weight:600;">${label}</label>
        <input id="pwInput" type="password"
               style="width:100%; padding:9px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; box-sizing:border-box;">
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button id="pwCancel" style="background:#eee; border:none; padding:8px 12px; border-radius:9px; cursor:pointer;">${cancelText}</button>
          <button id="pwOk" style="background:#FA1E32; color:#fff; border:none; padding:8px 12px; border-radius:9px; cursor:pointer;">${confirmText}</button>
        </div>
        <p id="pwErr" style="display:none; color:#FA1E32; margin-top:8px; font-size:13px;">Kunne ikke låse op – prøv igen.</p>
      </div>`;

    document.body.appendChild(overlay);
    const inp = overlay.querySelector("#pwInput");
    const btnOk = overlay.querySelector("#pwOk");
    const btnCancel = overlay.querySelector("#pwCancel");

    const cleanup = () => overlay.remove();
    const submit = () => { const v = (inp.value || "").trim(); cleanup(); resolve(v); };
    const cancel = () => { cleanup(); reject(new Error("Afbrudt")); };

    btnOk.addEventListener("click", submit);
    btnCancel.addEventListener("click", cancel);
    inp.addEventListener("keydown", e => { if (e.key === "Enter") submit(); if (e.key === "Escape") cancel(); });
    setTimeout(() => inp.focus(), 0);
  });
}

async function loadDataEncrypted() {
  const url = ENC_URL + (ENC_URL.includes('?') ? '&' : '?') + 'v=' + Date.now(); // cache-bust
  const res = await fetch(url);
  if (!res.ok) throw new Error("Kunne ikke hente encrypted_data.json");
  const blob = await res.json();

  const pw = await askPasswordModal({ title:"Realdanias borgmesterværktøj", label:"Indtast adgangskode" });

  const b64 = s => Uint8Array.from(atob(s), c => c.charCodeAt(0));
  const salt = b64(blob.salt), iv = b64(blob.iv), ct = b64(blob.ct), tag = b64(blob.tag);

  // PBKDF2 → AES-GCM
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pw), {name:"PBKDF2"}, false, ["deriveKey"]);
  const key = await crypto.subtle.deriveKey(
    {name:"PBKDF2", salt, iterations: blob.iter, hash:"SHA-256"},
    keyMaterial,
    {name:"AES-GCM", length:256},
    false, ["decrypt"]
  );

  // AES-GCM forventer ct||tag
  const sealed = new Uint8Array(ct.length + tag.length);
  sealed.set(ct, 0); sealed.set(tag, ct.length);

  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, sealed);
  const text = new TextDecoder().decode(plain);
  return JSON.parse(text);
}

// ===== UI/STATE =====
let DATA = [];
const TABLE_COLS = ["Kommune", "Borgmester", "Parti", "Stemmeandel", "Alder i valgåret", "Køn", "Anciennitet", "Borgmester før valget", "Kommunegruppe"];
const SELECTED_COLS = ["Kommune", "Borgmester", "Parti", "Stemmeandel", "Køn", "Anciennitet", "Område"];
const MAX_SELECTED = 7;
const QUICK_COMMUNES = ["Billund", "Høje-Taastrup", "Køge"];
const REQUIRED_NAMES = ["Michael Ziegler", "Stephanie Storbank"];
const ALLOWED_PARTIES = ["A", "V", "C", "I", "F"];
const ALLOWED_DOUBLE_AREA = "10";
const MAX_AGE = 70;

const K_KOMMUNE         = "Kommune";
const K_BORGMESTER      = "Borgmester";
const K_PARTI           = "Parti";
const K_STEMME          = "Stemmeandel";
const K_ALDER           = "Alder i valgåret";
const K_KOEN            = "Køn";
const K_ANCI            = "Anciennitet";
const K_BORGMESTER_FOER = "Borgmester før valget";
const K_GRUPPE          = "Kommunegruppe";
const K_LANDSDEL        = "Landsdel";
const K_OMRAADE         = "Område";
const K_HARREPR         = "Har været repræsenteret";
const K_KONST           = "Konstituering faldet på plads";
const K_GENOP           = "Genopstiller som borgmester ved KV25";

let state = {
  query: "",
  filters: {
    "Køn": new Set(),
    "Landsdel": new Set(),
    "Område": new Set(),
    "Parti": new Set(),
    "Kommunegruppe": new Set(),
    "Tidligere valgt fra valggruppen": new Set(),
    "Anciennitet": new Set(),
    "Konstituering faldet på plads": new Set(),
  },
  selectedIds: new Set(),
};

function normalize(s) { return (s||"").toString().toLowerCase(); }
const str = (x) => (x ?? "").toString();

// === BASIS-SETS TIL KOMBINATIONER ===
let BASE_IDS = new Set();        // svarer til df_base (basisfilter)
let REQUIRED_IDS = new Set();    // de to fastlåste borgmestre
let CANDIDATE_IDS = [];          // df_candidates (uden de faste, kun A/V/C/I/F)
let CANDIDATE_IDS_SET = new Set();
let ALL_KG_GROUPS_COUNT = 0;     // antal forskellige kommunegrupper i df_base

function parseAge(row) {
  const v = row[K_ALDER];
  if (typeof v === "number") return v;
  if (v === null || v === undefined) return NaN;
  const s = String(v).trim();
  if (!s) return NaN;
  const sNorm = s.replace(",", ".");
  const num = parseFloat(sNorm);
  return Number.isNaN(num) ? NaN : num;
}

function initBaseSets() {
  BASE_IDS = new Set();
  REQUIRED_IDS = new Set();
  CANDIDATE_IDS = [];
  CANDIDATE_IDS_SET = new Set();
  const kgSet = new Set();

  for (let idx = 0; idx < DATA.length; idx++) {
    const row = DATA[idx];
    const name = str(row[K_BORGMESTER]);
    const ageNum = parseAge(row);
    const harRepr = str(row[K_HARREPR]);
    const parti = str(row[K_PARTI]);
    const gruppe = str(row[K_GRUPPE]);

    const isRequired = REQUIRED_NAMES.includes(name);
    const reprOk = (harRepr === "Nej");
    const ageOk = !Number.isNaN(ageNum) && ageNum < MAX_AGE;

    // NYT: markér de faste borgmestre eksplicit
    if (isRequired) {
      REQUIRED_IDS.add(idx);
    }

    // BASE_IDS = df_base: enten fastlåst, eller (repræsenteret == Nej og alder < 70)
    if (isRequired || (reprOk && ageOk)) {
      BASE_IDS.add(idx);
      if (gruppe) kgSet.add(gruppe);
    }

    // CANDIDATE_IDS = df_candidates: df_base uden de faste, kun ALLOWED_PARTIES
    if (!isRequired && reprOk && ageOk && ALLOWED_PARTIES.includes(parti)) {
      CANDIDATE_IDS.push(idx);
    }
  }

  CANDIDATE_IDS_SET = new Set(CANDIDATE_IDS);
  ALL_KG_GROUPS_COUNT = kgSet.size;
}

// EKSPPLICIT filtreringslogik pr. facet – alt sammenlignes som tekst
function matchesFilters(row) {
  const f = state.filters;

  if (f["Køn"].size && !f["Køn"].has(str(row[K_KOEN]))) return false;
  if (f["Landsdel"].size && !f["Landsdel"].has(str(row[K_LANDSDEL]))) return false;
  if (f["Område"].size && !f["Område"].has(str(row[K_OMRAADE]))) return false;
  if (f["Parti"].size && !f["Parti"].has(str(row[K_PARTI]))) return false;
  if (f["Kommunegruppe"].size && !f["Kommunegruppe"].has(str(row[K_GRUPPE]))) return false;
  if (f["Tidligere valgt fra valggruppen"].size && !f["Tidligere valgt fra valggruppen"].has(str(row[K_HARREPR]))) return false;
  if (f["Anciennitet"].size && !f["Anciennitet"].has(str(row[K_ANCI]))) return false;
  if (f["Konstituering faldet på plads"].size && !f["Konstituering faldet på plads"].has(str(row[K_KONST]))) return false;

  return true;
}

function matchesQuery(row) {
  if (!state.query) return true;
  const hay = [
    row[K_KOMMUNE], row[K_BORGMESTER], row[K_PARTI],
    row[K_LANDSDEL], row[K_OMRAADE], row[K_GRUPPE],
    row[K_KOEN], row[K_HARREPR], row[K_GENOP],
    row[K_ANCI], row[K_KONST], row[K_BORGMESTER_FOER],
    String(row[K_ALDER] ?? ""), String(row[K_STEMME] ?? "")
  ].map(normalize).join(" ");
  return hay.includes(normalize(state.query));
}

function filteredData() {
  return DATA
    .map((r, idx) => ({ ...r, __id: idx }))
    .filter(r => matchesFilters(r) && matchesQuery(r));
}

function setLimitMsg(show) {
  document.getElementById("limitMsg").style.display = show ? "block" : "none";
}

function enforceMaxSelection(onAttemptOver) {
  if (state.selectedIds.size > MAX_SELECTED) {
    onAttemptOver();
    setLimitMsg(true);
    return false;
  }
  setLimitMsg(false);
  return true;
}

// opdaterer lille tekst om antal viste borgmestre
function updateTableCount(count) {
  const el = document.getElementById("tableCount");
  if (!el) return;
  el.textContent = "Viser " + count + " borgmestre";
}

function renderTable() {
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  const rows = filteredData();

  // opdatér tæller
  updateTableCount(rows.length);

  for (const r of rows) {
    const tr = document.createElement("tr");

    const td0 = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = state.selectedIds.has(r.__id);
    cb.addEventListener("change", (e) => {
      if (e.target.checked) {
        state.selectedIds.add(r.__id);
        if (!enforceMaxSelection(() => {
          state.selectedIds.delete(r.__id);
          e.target.checked = false;
        })) return;
      } else {
        state.selectedIds.delete(r.__id);
      }
      updateKPIs();
      updateExportButton();
      renderSelectedTable();
    });
    td0.appendChild(cb);
    tr.appendChild(td0);

    for (const col of TABLE_COLS) {
      const td = document.createElement("td");
      const value = r[col];

      if (col === K_BORGMESTER && (!value || String(value).trim() === "")) {
        td.textContent = "Endnu ikke konstitueret";
        td.style.fontStyle = "italic";
      } else {
        td.textContent = value ?? "";
      }

      tr.appendChild(td);
    }
    tb.appendChild(tr);
  }

  updateKPIs();
  updateExportButton();
  renderSelectedTable();
}

function renderSelectedTable() {
  const container = document.querySelector(".selected-container");
  const tb = container.querySelector("#tblSelected tbody");
  const title = container.querySelector(".selected-title");
  tb.innerHTML = "";

  const ids = Array.from(state.selectedIds);
  title.textContent = 'Valgte (' + ids.length + '):';

  if (ids.length === 0) {
    container.style.display = "none";
    return;
  } else {
    container.style.display = "block";
  }

  for (const id of ids) {
    const row = DATA[id];
    const tr = document.createElement("tr");

    const td0 = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "btn small";
    btn.textContent = "Fjern";
    btn.addEventListener("click", () => {
      state.selectedIds.delete(id);
      renderTable();
    });
    td0.appendChild(btn);
    tr.appendChild(td0);

    for (const col of SELECTED_COLS) {
      const td = document.createElement("td");
      const value = row[col];

      if (col === K_BORGMESTER && (!value || String(value).trim() === "")) {
        td.textContent = "Endnu ikke konstitueret";
        td.style.fontStyle = "italic";
      } else {
        td.textContent = value ?? "";
      }

      tr.appendChild(td);
    }
    tb.appendChild(tr);
  }
}

function summarizeSelected() {
  const selected = Array.from(state.selectedIds).map(id => DATA[id]);
  const count = selected.length;

  let ages = selected
    .map(r => Number(parseAge(r)))
    .filter(x => !Number.isNaN(x));
  const meanAge = ages.length ? (ages.reduce((a,b)=>a+b,0)/ages.length) : null;

  const by = (key) => {
    const m = new Map();
    for (const r of selected) {
      const k = r[key] ?? "";
      m.set(k, (m.get(k) || 0) + 1);
    }
    return Array.from(m.entries())
      .filter(([k,_]) => (k ?? "") !== "")
      .sort((a,b) => b[1]-a[1])
      .map(([k,v]) => `${k}:${v}`)
      .join(", ") || "-";
  };

  const gender = (() => {
    const m = new Map();
    for (const r of selected) {
      const k = r[K_KOEN] ?? "";
      m.set(k, (m.get(k) || 0) + 1);
    }
    const K = m.get("K") || 0;
    const M = m.get("M") || 0;
    return `${K} / ${M}`;
  })();

  return {
    count,
    gender,
    landsdel: by(K_LANDSDEL),
    gruppe: by(K_GRUPPE),
    parti: by(K_PARTI),
    omraade: by(K_OMRAADE),
    meanAge,
  };
}

function updateKPIs() {
  const s = summarizeSelected();
  document.getElementById("kpi_total_selected").textContent = s.count;
  document.getElementById("kpi_mean_age").textContent =
    (s.meanAge == null) ? "-" : s.meanAge.toFixed(1).replace('.', ',');
  document.getElementById("kpi_gender").textContent = s.gender;
  document.getElementById("kpi_landsdel").textContent = s.landsdel;
  document.getElementById("kpi_kommunegruppe").textContent = s.gruppe;
  document.getElementById("kpi_parti").textContent = s.parti;
  document.getElementById("kpi_omraade").textContent = s.omraade;
}

function updateExportButton() {
  const btn = document.getElementById("exportCsv");
  if (!btn) return;
  btn.disabled = state.selectedIds.size === 0;
}

function exportSelectedCSV() {
  const rows = Array.from(state.selectedIds).map(id => DATA[id]);
  if (!rows.length) return;

  const header = TABLE_COLS;

  function csvEscape(v) {
    const s = (v === null || v === undefined) ? "" : String(v);
    if (s.includes('"') || s.includes(',') || s.includes('\n')) {
      return '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }

  const lines = [];
  lines.push(["Valgt", ...header].join(","));
  for (const r of rows) {
    const line = ["Ja", ...header.map(k => csvEscape(r[k]))].join(",");
    lines.push(line);
  }

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "udvalgte_borgmestre.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// === KOMBINATIONSLOGIK PÅ KLIENTEN (enumerér alle gyldige m. de valgte) ===

function comboMeetsConstraints(idSet) {
  const rows = Array.from(idSet).map(id => DATA[id]);

  // --- Faste borgmestre ---
  const others = rows.filter(r => !REQUIRED_NAMES.includes(str(r[K_BORGMESTER])));

  // --- Partilogik ---
  const partyCounts = {A:0, V:0, C:0, I:0, F:0};
  for (const r of rows) {
    const p = str(r[K_PARTI]);
    if (partyCounts.hasOwnProperty(p)) partyCounts[p] += 1;
  }
  const cnt_A = partyCounts.A;
  const cnt_V = partyCounts.V;
  const cnt_C = partyCounts.C;
  const cnt_I = partyCounts.I;
  const cnt_F = partyCounts.F;
  const total_IF = cnt_I + cnt_F;
  const has_I = cnt_I > 0;

  const allowedPatterns = new Set();
  allowedPatterns.add("2,2,2,1"); // baseline

  if (has_I) {
    allowedPatterns.add("2,1,2,2");
    allowedPatterns.add("2,2,1,2");
    allowedPatterns.add("3,1,2,1");
    allowedPatterns.add("3,2,1,1");
  }

  const patternKey = `${cnt_A},${cnt_V},${cnt_C},${total_IF}`;
  if (!allowedPatterns.has(patternKey)) return false;

  if (total_IF === 2) {
    if (!(cnt_I >= 1 && cnt_F >= 1)) return false;
  }

  // --- Køn: forskel max 1 ---
  let mCount = 0, kCount = 0;
  for (const r of rows) {
    const g = str(r[K_KOEN]);
    if (g === "M") mCount++;
    if (g === "K") kCount++;
  }
  if (Math.abs(mCount - kCount) > 1) return false;

  // --- Anciennitet: 4/3 eller 5/2 i Genvalgts favør ---
  let gCount = 0, nCount = 0;
  for (const r of rows) {
    const a = str(r[K_ANCI]);
    if (a === "Genvalgt") gCount++;
    if (a === "Nyvalgt") nCount++;
  }
  if (!((gCount === 4 && nCount === 3) || (gCount === 5 && nCount === 2))) return false;

  // --- Har været repræsenteret = "Nej" for de andre (ikke de faste) ---
  for (const r of others) {
    if (str(r[K_HARREPR]) !== "Nej") return false;
  }

  // --- Alder < 70 for de andre ---
  for (const r of others) {
    const age = parseAge(r);
    if (!Number.isNaN(age) && age >= MAX_AGE) return false;
  }

  // --- Område-regel ---
  const areaCounts = new Map();
  for (const r of rows) {
    const a = str(r[K_OMRAADE]);
    const prev = areaCounts.get(a) || 0;
    areaCounts.set(a, prev + 1);
  }

  for (const [area, cnt] of areaCounts.entries()) {
    if (area === ALLOWED_DOUBLE_AREA) continue;
    if (cnt > 1) return false;
  }

  const countAreaDouble = areaCounts.get(ALLOWED_DOUBLE_AREA) || 0;
  const hasEmil = rows.some(r => str(r[K_BORGMESTER]) === "Emil Blücher");

  if (countAreaDouble > 2) return false;
  if (countAreaDouble === 2 && !hasEmil) return false;

  // --- Kommunegruppe: nogenlunde fordeling ---
  const kgCounts = new Map();
  for (const r of rows) {
    const g = str(r[K_GRUPPE]);
    if (!g) continue;
    kgCounts.set(g, (kgCounts.get(g) || 0) + 1);
  }
  const nGroups = kgCounts.size;
  const minRequiredGroups = Math.min(3, ALL_KG_GROUPS_COUNT);
  if (nGroups < minRequiredGroups) return false;

  let maxPerGroup = 0;
  for (const cnt of kgCounts.values()) {
    if (cnt > maxPerGroup) maxPerGroup = cnt;
  }
  if (maxPerGroup > 3) return false;

  return true;
}

function generateCombosWithSelected(maxResults = 5000, maxVisited = 200000) {
  const res = {
    combos: [],      // hver combo er et array af ids (fulde 7'ere)
    complete: true,  // false hvis vi ramte maxVisited før udtømning
    visited: 0,
    status: ""
  };

  const msgInvalid = (txt) => {
    res.status = txt;
    return res;
  };

  if (!BASE_IDS || BASE_IDS.size === 0) {
    return msgInvalid("Basisdatasættet til kombinationer er tomt.");
  }

  const selectedIds = Array.from(state.selectedIds || []);
  const badIds = [];

  for (const id of selectedIds) {
    if (!BASE_IDS.has(id)) {
      badIds.push(id);
    } else if (!REQUIRED_IDS.has(id) && !CANDIDATE_IDS_SET.has(id)) {
      badIds.push(id);
    }
  }

  if (badIds.length) {
    return msgInvalid("Mindst én af de valgte borgmestre kan ikke indgå i en gyldig kombination pga. reglerne (repræsentation, alder eller parti).");
  }

  const startingIds = new Set([...REQUIRED_IDS, ...selectedIds]);
  if (startingIds.size > MAX_SELECTED) {
    return msgInvalid("Der er allerede valgt flere end " + MAX_SELECTED + " borgmestre.");
  }

  const needed = MAX_SELECTED - startingIds.size;
  if (needed === 0) {
    if (comboMeetsConstraints(startingIds)) {
      res.combos.push(Array.from(startingIds));
      return res;
    } else {
      return msgInvalid("De valgte borgmestre opfylder ikke alle reglerne.");
    }
  }

  const available = CANDIDATE_IDS.filter(id => !startingIds.has(id));
  if (available.length < needed) {
    return msgInvalid("Der findes ikke nok egnede borgmestre til at fuldende en gyldig kombination med de nuværende valg.");
  }

  function backtrack(startIndex, pickedExtra) {
    if (res.combos.length >= maxResults || res.visited >= maxVisited) {
      res.complete = false;
      return;
    }

    if (pickedExtra.length === needed) {
      const set = new Set([...startingIds, ...pickedExtra]);
      res.visited += 1;
      if (comboMeetsConstraints(set)) {
        res.combos.push(Array.from(set));
      }
      return;
    }

    for (let i = startIndex; i < available.length; i++) {
      const remainingSlots = needed - pickedExtra.length;
      const remainingCandidates = available.length - i;
      if (remainingCandidates < remainingSlots) break;

      pickedExtra.push(available[i]);
      backtrack(i + 1, pickedExtra);
      pickedExtra.pop();

      if (res.combos.length >= maxResults || res.visited >= maxVisited) {
        res.complete = false;
        return;
      }
    }
  }

  backtrack(0, []);
  return res;
}

function autoFillFromRules() {
  const msgEl = document.getElementById("autoMsg");
  if (msgEl) {
    msgEl.style.display = "none";
    msgEl.textContent = "";
  }

  const result = generateCombosWithSelected(5000, 200000);

  if (result.status) {
    if (msgEl) {
      msgEl.textContent = result.status;
      msgEl.style.display = "block";
    }
    return;
  }

  if (!result.combos.length) {
    if (msgEl) {
      msgEl.textContent = "Der kunne ikke findes en gyldig kombination, der opfylder alle reglerne med de nuværende valg.";
      msgEl.style.display = "block";
    }
    return;
  }

  if (msgEl) {
    let txt = "Der findes " + result.combos.length + " gyldige kombinationer med de valgte borgmestre.";
    if (!result.complete) {
      txt += " (Vi stoppede ved en søgegrænse; der kan være flere.)";
    }
    msgEl.textContent = txt;
    msgEl.style.display = "block";
  }

  const chosen = result.combos[Math.floor(Math.random() * result.combos.length)];
  state.selectedIds = new Set(chosen);
  renderTable();
}

function attachEvents() {
  document.getElementById("searchBox").addEventListener("input", (e) => {
    state.query = e.target.value;
    renderTable();
  });

  for (const el of document.querySelectorAll('input[type="checkbox"][data-facet]')) {
    el.addEventListener("change", (e) => {
      const facet = e.target.getAttribute("data-facet");
      const val = e.target.value;
      const set = state.filters[facet];
      if (!set) return;
      if (e.target.checked) set.add(val); else set.delete(val);
      renderTable();
    });
  }

  document.getElementById("clearFilters").addEventListener("click", () => {
    for (const el of document.querySelectorAll('input[type="checkbox"][data-facet]')) {
      el.checked = false;
    }
    state.filters = {
      "Køn": new Set(),
      "Landsdel": new Set(),
      "Område": new Set(),
      "Parti": new Set(),
      "Kommunegruppe": new Set(),
      "Tidligere valgt fra valggruppen": new Set(),
      "Anciennitet": new Set(),
      "Konstituering faldet på plads": new Set(),
    };
    renderTable();
  });

  // Quickselect: kun de tre kommuner, hvor Anciennitet = "Genvalgt"
  document.getElementById("quickSelect").addEventListener("click", () => {
    const rows = DATA
      .map((r, idx) => ({ ...r, __id: idx }))
      .filter(r => QUICK_COMMUNES.includes(r[K_KOMMUNE]) && str(r[K_ANCI]) === "Genvalgt");

    for (const r of rows) {
      state.selectedIds.add(r.__id);
      if (state.selectedIds.size > MAX_SELECTED) {
        setLimitMsg(true);
        break;
      }
    }
    renderTable();
  });

  document.getElementById("clearSelectedAll").addEventListener("click", () => {
    state.selectedIds.clear();
    renderTable();
  });

  document.getElementById("exportCsv").addEventListener("click", exportSelectedCSV);

  const autoBtn = document.getElementById("autoFill");
  if (autoBtn) {
    autoBtn.addEventListener("click", autoFillFromRules);
  }
}

// Init — hent krypterede data, dekrypter, og kør
window.addEventListener('DOMContentLoaded', async () => {
  try {
    DATA = await loadDataEncrypted();
    initBaseSets();
    document.getElementById("loader").style.display = "none";
    document.getElementById("searchBox").disabled = false;
    attachEvents();
    renderTable();
  } catch (e) {
    document.getElementById("loader").textContent = "Kunne ikke dekryptere data: " + e.message;
  }
});

</script>
</body>
</html>
